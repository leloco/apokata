#!/bin/bash

PROJECT_ROOT=$(git rev-parse --show-toplevel)
CONFIG_PATH="$PROJECT_ROOT/.sops.yaml"

encrypt_files() {
    local rel_dir=$1      # Relative path from project root
    local extension=$2    # File extension (e.g., tfvars or jwk)
    local sops_type=$3     # SOPS data type (e.g., dotenv or json)

    if [ ! -d "$PROJECT_ROOT/$rel_dir" ]; then
        echo "Info: Directory $rel_dir does not exist. Skipping..."
        return
    fi

    for file in "$PROJECT_ROOT/$rel_dir"/*."$extension"; do
        [ -e "$file" ] || continue
        
        filename=$(basename "$file")
        
        # Skip files that are already encrypted
        if [[ "$filename" == *.enc ]]; then
            continue
        fi

        echo "Protecting file: $rel_dir/$filename (Type: $sops_type)"
        
        sops --encrypt \
             --config "$CONFIG_PATH" \
             --input-type "$sops_type" \
             --output-type "$sops_type" \
             "$file" > "$PROJECT_ROOT/$rel_dir/$filename.enc"
        
        git add "$PROJECT_ROOT/$rel_dir/$filename.enc"
    done
}

encrypt_files "opentofu/infra" "tfvars" "dotenv"
encrypt_files "ansible/roles/tang/files/tang-keys" "jwk" "json"


echo "Starting security check for unencrypted secrets..."

UNENCRYPTED_FILES=$(git diff --cached --name-only --diff-filter=d | grep -E "\.(tfvars|jwk)$" | grep -v "\.enc$")

if [ -n "$UNENCRYPTED_FILES" ]; then
    echo "######################################################################"
    echo "ATTENTION: SECURITY RISK DETECTED!"
    echo "The following files are unencrypted in the staging area:"
    echo "$UNENCRYPTED_FILES"
    echo "----------------------------------------------------------------------"
    echo "Committing these files is NOT permitted."
    echo "Please remove them with: git restore --staged <file>"
    echo "######################################################################"
    exit 1
else
    echo "Check passed: No unencrypted secrets found."
fi

exit 0
